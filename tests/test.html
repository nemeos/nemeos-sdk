<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
  </head>
  <body>
    <h1>Nemeos SDK Test</h1>

    <div>
      Is wallet connected?
      <span id="isConnected">false</span>
    </div>

    <div>
      <button id="connectWallet">Connect wallet</button>
    </div>
    <div>
      <button id="startLoan">Start Loan for nftId 224 and 90 days</button>
    </div>
    <div>
      <button id="retrieveLoan">Retrieve Loan for nftId 224</button>
    </div>
    <div>
      <button id="payNextLoanStep">Pay Next Loan Step for nftId 224</button>
    </div>

    <script type="module">
      import * as ethers from 'ethers'
      import { NemeosSDK } from '../src/index.ts'

      let signer
      let nemeosSdk
      let nemeosPool

      const nemeosPoolAddress = '0x812db15b8Bb43dBA89042eA8b919740C23aD48a3'
      const cyberKongzAddress = '0x15cd1cfCd48C06cfC44D433D66C7a9fE06b2C2c3'

      export async function isMetamaskConnected() {
        if (!window.ethereum) return false

        try {
          const _provider = new ethers.BrowserProvider(window.ethereum)
          const accounts = await _provider.send('eth_accounts', [])
          return accounts && accounts.length > 0
        } catch (error) {
          console.error('[isMetamaskConnected] There was an error while trying to connect to Metamask isMetamaskConnected()', { error })
          return false
        }
      }

      async function connectWallet() {
        const wallet = new ethers.BrowserProvider(window.ethereum)
        signer = await wallet.getSigner()

        nemeosSdk = new NemeosSDK(signer)
        nemeosPool = nemeosSdk.getPool({
          nemeosPoolAddress,
          nftCollectionAddress: cyberKongzAddress,
        })
      }

      async function startLoan() {
        await nemeosPool.startLoan(224, 90)
      }
      async function retrieveLoan() {
        await nemeosPool.retrieveLoan(224)
      }
      async function payNextLoanStep() {
        await nemeosPool.payNextLoanStep(224)
      }

      function addEventListeners() {
        document.getElementById('connectWallet').addEventListener('click', connectWallet)
        document.getElementById('startLoan').addEventListener('click', startLoan)
        document.getElementById('retrieveLoan').addEventListener('click', retrieveLoan)
        document.getElementById('payNextLoanStep').addEventListener('click', payNextLoanStep)
      }

      document.addEventListener('DOMContentLoaded', async () => {
        addEventListeners()
        if (await isMetamaskConnected()) {
          document.getElementById('isConnected').innerText = 'true'
          connectWallet()
        }
      })
    </script>
  </body>
</html>
